!function(global,name,definition){"undefined"!=typeof module?module.exports=definition:"function"==typeof define&&"object"==typeof define.amd?define(definition):global[name]=definition()}(this,"Selectorablium",function(){var LocalStorageShim;LocalStorageShim=function(){LocalStorageShim.instance=null;function LocalStorageShim(){return null!==LocalStorageShim.instance?LocalStorageShim.instance:(this.length=0,this._data={},void(LocalStorageShim.instance=this))}return LocalStorageShim.prototype.getItem=function(key){var value;return value=this._data[key],void 0===value?null:value},LocalStorageShim.prototype.setItem=function(key,value){return this._data[key]=value,this.length+=1,!0},LocalStorageShim.prototype.removeItem=function(key){return this._data[key]?(this._data[key]=null,delete this._data[key],this.length-=1,!0):!1},LocalStorageShim.prototype.clear=function(){var item;this.length=0;for(item in this._data)this._data[item]=null;return this._data={},!0},LocalStorageShim.prototype.key=function(index){var i,key,value,_ref;i=0,_ref=this._data;for(key in _ref){if(value=_ref[key],i===index)return key;i++}return!1},LocalStorageShim}();var __slice=[].slice,StorageFreak;StorageFreak=function(){StorageFreak.prototype._defaults={namespace:"selectorablium",sort_func:function(a,b){return a.name<b.name?-1:1},match_func:function(RE,name){var result;return result=RE.test(name),RE.lastIndex=0,result}},StorageFreak.prototype._required=["url","name","query","app_name","XHRTimeout","maxResultsNum","localCacheTimeout","minCharsForRemoteSearch","list_of_replacable_chars"];function StorageFreak(options){var attr,_i,_len,_ref;if(this instanceof StorageFreak==!1)return new StorageFreak(options);for(this.options=options,this.config=$.extend({},this._defaults,this.options),_ref=this._required,_i=0,_len=_ref.length;_len>_i;_i++)if(attr=_ref[_i],!this.config[attr])throw new Error("'"+attr+"' option is required");this._db_prefix=""+this.config.namespace+"."+this.config.app_name,this._data_key=""+this.config.name+"_data",this._timestamp_key=""+this.config.name+"_timestamp",this._data={},this._events={},this.timeout=null,this.XHR_dfd=null,this._storage=this._getStorage()}return StorageFreak.prototype.on=function(event_name,callback,context){var _base;return null==context&&(context=null),null==(_base=this._events)[event_name]&&(_base[event_name]=[]),this._events[event_name].push({callback:callback,context:context})},StorageFreak.prototype.init=function(){return this._isInvalidData()?this._getRemoteData("",{event_name:"dbcreate"}):(this._data=this._get(this._data_key),(new $.Deferred).resolve())},StorageFreak.prototype.searchByKey=function(key){return this._data[key]||!1},StorageFreak.prototype.search=function(query,options){var results;return null==options&&(options={}),results=this._searchData(query,options),this._trigger("dbsearch_results",results,query),this._resetRemote(),query.length>=this.config.minCharsForRemoteSearch?(this._trigger("dbremote_search_in",this.config.XHRTimeout),this.timeout=setTimeout(function(_this){return function(){return _this._getRemoteData(query,options).then(function(){return results=_this._searchData(query,options),_this._trigger("dbsearch_results",results,query,"xhr")})}}(this),this.config.XHRTimeout)):void 0},StorageFreak.prototype.cleanup=function(){return this._resetRemote()},StorageFreak.prototype._resetRemote=function(){var _base;return this._trigger("dbremote_search_reset"),this.timeout&&clearTimeout(this.timeout),this.XHR_dfd&&("function"==typeof(_base=this.XHR_dfd).abort?_base.abort():void 0)},StorageFreak.prototype._searchData=function(query,options){var id,match_func,name,re,results,sort_func,_ref;results=[],match_func=options.match_func||this.config.match_func,sort_func=options.sort_func||this.config.sort_func,re=this._createAccentIndependentRE(query),_ref=this._data;for(id in _ref)name=_ref[id],match_func(re,name)&&results.push({id:id,name:name});return results=results.sort(sort_func),results.slice(0,this.config.maxResultsNum)},StorageFreak.prototype._getRemoteData=function(query,options){var dfd,params,query_param;return this._trigger(""+(options.event_name||"dbremote_search")+"_start"),dfd=new $.Deferred,params={},query&&(query_param=options.query||this.config.query,params[query_param]=query),this.XHR_dfd=$.getJSON(options.url||this.config.url,params),this.XHR_dfd.then(function(_this){return function(json_data){return _this._getRemoteSuccess(json_data,dfd,options)}}(this),function(_this){return function(xhr){return _this._getRemoteError(xhr,dfd,options)}}(this)),dfd},StorageFreak.prototype._getRemoteSuccess=function(json_data,dfd,options){return this._data=$.extend({},this._data,this._parseResponseData(json_data)),this._updateDB(this._data),this._trigger(""+(options.event_name||"dbremote_search")+"_end"),dfd.resolve()},StorageFreak.prototype._getRemoteError=function(xhr,dfd,options){return this._trigger(""+(options.event_name||"dbremote_search")+"_error",xhr),dfd.reject(xhr)},StorageFreak.prototype._getStorage=function(){return localStorage?localStorage:new LocalStorageShim},StorageFreak.prototype._trigger=function(){var context,data,entry,event_name,_i,_len,_ref,_results;if(event_name=arguments[0],data=2<=arguments.length?__slice.call(arguments,1):[],this._events[event_name]){for(_ref=this._events[event_name],_results=[],_i=0,_len=_ref.length;_len>_i;_i++)entry=_ref[_i],context=entry.context||null,_results.push(entry.callback.apply(context,data));return _results}},StorageFreak.prototype._isInvalidData=function(){var db_ts,ts;return ts=(new Date).getTime(),db_ts=this._get(this._timestamp_key),db_ts&&(db_ts=parseInt(db_ts,10)),db_ts===!1||ts-db_ts>this.config.localCacheTimeout},StorageFreak.prototype._parseResponseData=function(json_data){var item,result,_i,_len;for(result={},_i=0,_len=json_data.length;_len>_i;_i++)item=json_data[_i],result[item.id]=item.name;return result},StorageFreak.prototype._updateDB=function(data){return this._set(this._data_key,data),this._set(this._timestamp_key,(new Date).getTime()),this._trigger("dbupdated")},StorageFreak.prototype._createAccentIndependentRE=function(query){var re,value,_i,_len,_ref;for(_ref=this.config.list_of_replacable_chars,_i=0,_len=_ref.length;_len>_i;_i++)value=_ref[_i],re=new RegExp(""+value[0]+"|"+value[1],"ig"),query=query.replace(re,"(?:"+value[0]+"|"+value[1]+")");return re=null,new RegExp("^"+query,"ig")},StorageFreak.prototype._get=function(key){var value;if("string"!=typeof key||""===key)return!1;key=""+this._db_prefix+"."+key;try{value=JSON.parse(this._storage.getItem(key))}catch(_error){return!1}return null===value||""===value?!1:value},StorageFreak.prototype._set=function(key,value){if("string"!=typeof key||""===key)return!1;if(null===value||void 0===value)return!1;key=""+this._db_prefix+"."+key;try{this._storage.setItem(key,JSON.stringify(value))}catch(_error){return!1}return!0},StorageFreak}();var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__slice=[].slice,Selectorablium;return Selectorablium=function(){Selectorablium.prototype.defaults={minCharsForRemoteSearch:3,localCacheTimeout:6048e5,XHRTimeout:650,maxResultsNum:10,default_value:0,default_text:"Please select an option",selected_id:null,list_of_replacable_chars:[["\u03ac","\u03b1"],["\u03ad","\u03b5"],["\u03ae","\u03b7"],["\u03af","\u03b9"],["\u03cc","\u03bf"],["\u03cd","\u03c5"],["\u03ce","\u03c9"]]},Selectorablium.prototype._required=["app_name","url","query","name","minCharsForRemoteSearch","XHRTimeout","list_of_replacable_chars","localCacheTimeout"],Selectorablium.prototype.template='<div class="selectorablium_cont">\n  <div class="top">\n    <div class="initial_loader">Loading initial data...</div>\n    <a class="clear_button">Clear</a>\n  </div>\n  <div class="inner_container clearfix">\n    <form>\n      <input autocomplete="off" name="var_name">\n      <span class="input_icon"></span>\n      <div class="loader"></div>\n      <div class="XHRCounter"></div>\n    </form>\n    <ul class="list_container"></ul>\n  </div>\n</div>';function Selectorablium(element,options){this._onDBSearchResults=__bind(this._onDBSearchResults,this),this._onDBSearchReset=__bind(this._onDBSearchReset,this),this._onDBSearchError=__bind(this._onDBSearchError,this),this._onDBSearchEnd=__bind(this._onDBSearchEnd,this),this._onDBSearchStart=__bind(this._onDBSearchStart,this),this._onDBSearchIn=__bind(this._onDBSearchIn,this),this._onDBCreateEnd=__bind(this._onDBCreateEnd,this),this._onDBCreateStart=__bind(this._onDBCreateStart,this),this._onDBReady=__bind(this._onDBReady,this),this._onKeyUp=__bind(this._onKeyUp,this),this._onKeyPress=__bind(this._onKeyPress,this),this._activateSelectedItem=__bind(this._activateSelectedItem,this),this._onItemMouseEnter=__bind(this._onItemMouseEnter,this),this._onHTMLClick=__bind(this._onHTMLClick,this),this._onClearButtonClick=__bind(this._onClearButtonClick,this),this._onContainerClick=__bind(this._onContainerClick,this),this._togglePlugin=__bind(this._togglePlugin,this);var attr,_i,_len,_ref;if(this instanceof Selectorablium==!1)return new Selectorablium(element,options);if(!element)throw new Error("Element argument is required");for(this.$el=$(element),this.options=options,this.metadata=this.$el.data(),this.config=$.extend({},this.defaults,this.metadata,this.options),_ref=this._required,_i=0,_len=_ref.length;_len>_i;_i++)if(attr=_ref[_i],!this.config[attr])throw new Error("'"+attr+"' option is required");this.state="disabled",this.shift_pressed=!1,this.structure=[],this.indexed_structure={},this.$result_items=[],this.events_handled=[],this.db=new StorageFreak(this.config),this._createHtmlElements(),this._registerEventHandlers(),this.data_ready_dfd=this.db.init(),this.data_ready_dfd.then(this._onDBReady)}return Selectorablium.prototype.cleanup=function(){var item,_i,_len,_ref;for(this.db.cleanup(),_ref=this.events_handled,_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],item[0].off.apply(item[0],item[1]);return this.$container.remove(),this.$el.unwrap(),this.$outer_container.remove()},Selectorablium.prototype.then=function(success,fail){return this.data_ready_dfd.then(success,fail)},Selectorablium.prototype.reset=function(){return this._insertOptionElement(this.config.default_value,this.config.default_text)},Selectorablium.prototype.set=function(key,value){return null==value&&(value=null),null===value&&(value=this.db.searchByKey(key),value===!1)?!1:(this._insertOptionElement(key,value),this._hide(),!0)},Selectorablium.prototype._createHtmlElements=function(){return this.$el.wrap($('<div class="selectorablium_outer_cont">')),this.$outer_container=this.$el.parent(),this.$outer_container.append(this.template),this.$container=this.$outer_container.find(".selectorablium_cont"),this.$top=this.$container.find(".top"),this.$top_loader=this.$container.find(".initial_loader"),this.$inner_container=this.$container.find(".inner_container"),this.$input=this.$container.find("input"),this.$results_list=this.$container.find(".list_container"),this.$XHR_counter=this.$container.find(".XHRCounter"),this.$XHR_loader=this.$container.find(".loader"),this.$clear_button=this.$container.find(".clear_button"),this.reset()},Selectorablium.prototype._registerEventHandlers=function(){return this._addHandler(this.$top,"click",this._togglePlugin),this._addHandler(this.$el,"focus",this._togglePlugin),this._addHandler(this.$container,"click",this._onContainerClick),this._addHandler(this.$clear_button,"click",this._onClearButtonClick),this._addHandler($("html"),"click",this._onHTMLClick),this._addHandler(this.$input,"keyup",this._onKeyUp),this._addHandler(this.$input,this._keyPressEventName(),this._onKeyPress),this._addHandler(this.$results_list,"mouseenter",".item",this._onItemMouseEnter),this._addHandler(this.$results_list,"click",".item",this._activateSelectedItem),this.db.on("dbcreate_start",this._onDBCreateStart),this.db.on("dbcreate_end",this._onDBCreateEnd),this.db.on("dbremote_search_in",this._onDBSearchIn),this.db.on("dbremote_search_start",this._onDBSearchStart),this.db.on("dbremote_search_end",this._onDBSearchEnd),this.db.on("dbremote_search_error",this._onDBSearchError),this.db.on("dbremote_search_reset",this._onDBSearchReset),this.db.on("dbsearch_results",this._onDBSearchResults)},Selectorablium.prototype._togglePlugin=function(e){switch(this.state){case"disabled":break;case"visible":return this._hide();case"ready":if(this.$inner_container.is(":visible")===!1)return this._show()}},Selectorablium.prototype._onContainerClick=function(e){return this.do_not_hide_me=!0},Selectorablium.prototype._onClearButtonClick=function(e){return this.reset(),this._hide(),!1},Selectorablium.prototype._onHTMLClick=function(e){return this.do_not_hide_me===!0?this.do_not_hide_me=!1:this._hide()},Selectorablium.prototype._onItemMouseEnter=function(e){return this._selectItem($(e.currentTarget))},Selectorablium.prototype._activateSelectedItem=function(e){return this.selected_item&&(this._insertOptionElement(this.selected_item.data("value"),this.selected_item.text()),this.$el.trigger("change")),this._hide(),!1},Selectorablium.prototype._onKeyPress=function(e){switch(e.keyCode){case 16:this.shift_pressed=!0;break;case 27:this._hide();break;case 38:this._moveSelectedItem("up");break;case 40:this._moveSelectedItem("down");break;case 13:this._activateSelectedItem();break;case 9:return this._activateSelectedItem(),!0;default:return!0}return!1},Selectorablium.prototype._onKeyUp=function(e){switch(e.keyCode){case 17:case 18:case 37:case 38:case 39:case 40:case 27:case 13:case 91:case 20:case 33:case 34:case 35:case 36:case 45:case 9:return!1;case 16:return this.shift_pressed=!1,!1}return this._resetContainer(),this.selected_item=null,this.query=$.trim(this.$input.val()),0===this.query.length?(this._resetSelectedItem(),!1):(this.db.search(this.query),!1)},Selectorablium.prototype._onDBReady=function(data){return this.config.selected_id&&this.set(this.config.selected_id),this.state="ready"},Selectorablium.prototype._onDBCreateStart=function(){return this.state="disabled",this.$top_loader.show(),this.$top.addClass("disabled")},Selectorablium.prototype._onDBCreateEnd=function(){return this.$top_loader.hide(),this.$top.removeClass("disabled")},Selectorablium.prototype._onDBSearchIn=function(time){return this._showXHRCountdown(time)},Selectorablium.prototype._onDBSearchStart=function(){return this._hideXHRCountdown(),this.$XHR_loader.show()},Selectorablium.prototype._onDBSearchEnd=function(){return this.$XHR_loader.hide()},Selectorablium.prototype._onDBSearchError=function(xhr){return this.$XHR_loader.hide()},Selectorablium.prototype._onDBSearchReset=function(){return this._hideXHRCountdown(),this.$XHR_loader.hide()},Selectorablium.prototype._onDBSearchResults=function(results,query,xhr){var selected_item;return null==xhr&&(xhr=!1),query===this.query?(this._updateStructure(results,xhr),this._highlightResults(query),this.$result_items=this._appendResults(query),this.$result_items.filter(".new").hide().slideToggle(),0===(selected_item=this.$result_items.filter(".selected")).length&&(selected_item=this.$result_items.first()),this._selectItem(selected_item)):void 0},Selectorablium.prototype._updateStructure=function(results,xhr){var key,new_item,new_keys,result,value,_i,_len,_ref;for(this.structure=[],new_keys={},_i=0,_len=results.length;_len>_i;_i++)result=results[_i],new_keys[result.id]=!0,new_item={id:result.id,name:result.name,template:"",selected:!1,fresh:!!xhr},this.indexed_structure[result.id]&&(new_item=$.extend(new_item,this.indexed_structure[result.id])),this.indexed_structure[result.id]=new_item,this.structure.push(new_item);_ref=this.indexed_structure;for(key in _ref)value=_ref[key],new_keys[key]||(this.indexed_structure[key]=null,delete this.indexed_structure[key]);return this.structure},Selectorablium.prototype._highlightResults=function(query){var item,re,_i,_len,_ref,_results;for(re=this._createAccentIndependentRE(query),_ref=this.structure,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],_results.push(item.template=item.name.replace(re,'<span class="highlight">$1</span>'));return _results},Selectorablium.prototype._appendResults=function(query){return this.$results_list.empty(),this.$results_list.append(this._createTemplate(query)),this.$results_list.find(".item")},Selectorablium.prototype._createTemplate=function(query){var class_name,item,items_templates,text,_i,_len,_ref;if(items_templates=[],0===this.structure.length)text="No results found",items_templates.push("<li><p class='empty-message'>"+text+"</p></li>");else for(_ref=this.structure,_i=0,_len=_ref.length;_len>_i;_i++)item=_ref[_i],class_name="item",item.fresh===!0&&(class_name+=" new"),item.selected===!0&&(class_name+=" selected"),items_templates.push("<li><a href='#' class='"+class_name+"' data-value='"+item.id+"'>"+item.template+"</a></li>"),item.fresh=!1;return items_templates.join("\n")},Selectorablium.prototype._createAccentIndependentRE=function(query){var re,value,_i,_len,_ref;for(_ref=this.config.list_of_replacable_chars,_i=0,_len=_ref.length;_len>_i;_i++)value=_ref[_i],re=new RegExp(""+value[0]+"|"+value[1],"ig"),query=query.replace(re,"(?:"+value[0]+"|"+value[1]+")");return re=null,new RegExp("("+query+")","ig")},Selectorablium.prototype._addHandler=function(){var $element,on_args;return $element=arguments[0],on_args=2<=arguments.length?__slice.call(arguments,1):[],$element.on.apply($element,on_args),this.events_handled.push([$element,on_args])},Selectorablium.prototype._keyPressEventName=function(){var ff_ua_match;return ff_ua_match=window.navigator.userAgent.match(/Firefox\/\d+\.\d+\.\d+/),window.opera||ff_ua_match?"keypress":"keydown"},Selectorablium.prototype._insertOptionElement=function(value,text){return this.$el.html('<option value="'+value+'">'+text+"</option>")},Selectorablium.prototype._showXHRCountdown=function(milliseconds){return this.$XHR_counter.stop(!0,!0).css("width","0").show(),this.$XHR_counter.animate({width:"100%"},milliseconds,function(){return $(this).hide()})},Selectorablium.prototype._hideXHRCountdown=function(){return this.$XHR_counter.stop(!0,!0).hide()},Selectorablium.prototype._show=function(){return this.$container.addClass("active"),this.$el.addClass("active"),this.$inner_container.slideDown(200),this.$input.focus(),this.state="visible"},Selectorablium.prototype._hide=function(){return"visible"===this.state?(this.$container.removeClass("active"),this.$el.removeClass("active"),this.$inner_container.slideUp(200),this._resetSelectedItem(),this._resetContainer(),this.$input.val(""),this.query="",this.state="ready"):void 0},Selectorablium.prototype._resetContainer=function(){return this.$results_list.empty(),this.$XHR_loader.hide(),this._hideXHRCountdown()},Selectorablium.prototype._resetSelectedItem=function(){var ref;if(this.selected_item)return ref=this.indexed_structure[this.selected_item.data("value")],ref&&(ref.selected=!1),this.selected_item.removeClass("selected"),this.selected_item=null},Selectorablium.prototype._selectItem=function($item){return $item&&0!==$item.length?(this._resetSelectedItem(),this.selected_item=$item.addClass("selected"),this.indexed_structure[$item.data("value")].selected=!0):void 0},Selectorablium.prototype._getNextItem=function(direction){var count,custom_index,index,new_index;return count=this.$result_items.length,index=this.$result_items.index(this.selected_item)+count,custom_index="up"===direction?index-1:index+1,new_index=custom_index%count,$(this.$result_items.get(new_index))},Selectorablium.prototype._moveSelectedItem=function(direction){var $item;if(this.selected_item)return $item=this._getNextItem(direction),this._selectItem($item)},Selectorablium}(),$.fn.Selectorablium=function(options){this.each(function(){$.data(this,"Selectorablium")||$.data(this,"Selectorablium",new Selectorablium(this,options))})},Selectorablium});