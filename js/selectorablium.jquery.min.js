(function(){var h=function(e,h){return function(){return e.apply(h,arguments)}};(function(e,n,j){var i,l;l={minCharsForRemoteSearch:3,localCacheTimeout:6048E5,XHRTimeout:650,maxResultsNum:10,maxNewResultsNum:5,list_of_replacable_chars:[["\u03ac","\u03b1"],["\u03ad","\u03b5"],["\u03ae","\u03b7"],["\u03af","\u03b9"],["\u03cc","\u03bf"],["\u03cd","\u03c5"],["\u03ce","\u03c9"]]};i=function(a,b){if(!e.fn.toolsfreak||!e.fn.storagefreak)return!1;this.timers_func=e.fn.toolsfreak.timers_handler();this.el=
e(a).attr("autocomplete","off");this.options=e.extend({},l,b);if(!this.options.app_name||""===this.options.app_name)return this.__error("objectCreation","no app_name specified on params"),!1;this.options.url=this.el.data("url");this.options.query_string=this.el.data("query");this.options.data_name=this.el.data("name");this.options.default_value=this.el.data("default_value");this.options.default_text=this.el.data("default_text");this.options.selected_id=this.el.data("selected_id");this.db=null;this.db_prefix=
"skr."+this.options.app_name+".selectorablium.";this.el_initial_loader=this.el_clear=this.el_loader=this.el_XHRCounter=this.el_list_cont=this.el_input=this.el_inner_container=this.el_top=this.el_container=null;this.queryLength=this.query="";this.items_list=this.selected_item=this.result_list=this.data=null;this.result_to_prepend=[];this.got_focused=this.do_not_hide_me=this.no_results=!1;this.init()};i.prototype={name:"selectorablium",defaults:l,init:function(){this.createHtmlElements();this.makeDbPreparation();
this.registerEventHandlers()},makeDbPreparation:function(){this.db=i.getLocalDBObj();i.initiateLocalData.call(this)},createHtmlElements:function(){this.el_container=e('<div class="selectorablium_cont">').css({width:this.el.outerWidth(),minHeight:this.el.outerHeight()});this.el_container.append('<div class="top"><div class="initial_loader">Loading initial data...</div><a class="cancel_button">Clear</a></div><div class="inner_container clearfix"><form><input name="var_name"><span class="input_icon"></span><div class="loader"></div><div class="XHRCounter"></div></form><ul class="list_container"></ul></div>');
this.el_top=this.el_container.find(".top").css("height",this.el.outerHeight(!0));this.el_inner_container=this.el_container.find(".inner_container");this.el_input=this.el_container.find("input").attr("autocomplete","off");this.el_list_cont=this.el_container.find(".list_container");this.el_XHRCounter=this.el_container.find(".XHRCounter");this.el_loader=this.el_container.find(".loader");this.el_clear=this.el_container.find(".cancel_button").css({height:this.el.outerHeight(!0)+"px",lineHeight:this.el.outerHeight(!0)+
"px"});this.el_initial_loader=this.el_container.find(".initial_loader");this.el.parent().css("position","relative").append(this.el_container);this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>");this.el.css({borderBottomRightRadius:0,borderTopRightRadius:0})},registerEventHandlers:function(){this.el_top.on("click",h(function(){this.el_inner_container.is(":visible")?this.hide():!1===this.el_top.hasClass("disabled")&&(this.el_container.addClass("active"),
this.el.addClass("active"),this.el_inner_container.slideDown(200),this.el_input.focus())},this));this.el.on("focus",h(function(){this.el_inner_container.is(":visible")?this.hide():!1===this.el_top.hasClass("disabled")&&(this.el_container.addClass("active"),this.el.addClass("active"),this.el_inner_container.slideDown(200),this.el_input.focus())},this));this.el_container.on("click",h(function(){this.do_not_hide_me=!0},this));this.el_clear.on("click",h(function(a){a.stopPropagation();this.resetSelectItem();
return!1},this));e("html").on("click",h(function(){!0===this.do_not_hide_me?this.do_not_hide_me=!1:this.hide()},this));if(n.opera||e.browser.mozilla)this.el_input.on("keypress",h(function(a){return this.onKeyPress(a)},this));else this.el_input.on("keydown",h(function(a){return this.onKeyPress(a)},this));this.el_input.on("keyup",h(function(a){return this.onKeyUp(a)},this))},hide:function(){this.el_inner_container.is(":visible")&&(this.el_container.removeClass("active"),this.el.removeClass("active"),
this.el_inner_container.slideUp(200),this.el_input.val(""),this.el_list_cont.empty(),this.el_loader.hide(),this.el_XHRCounter.hide(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.query="")},onKeyPress:function(a){switch(a.keyCode){case 9:return this.selected_item?this.activateTheSelectedItem():this.hide(),!0;case 27:this.hide();break;case 38:return this.moveSelectedElement("up"),!1;case 40:return this.moveSelectedElement("down"),!1;case 13:return this.activateTheSelectedItem(),
!1;case 37:return!0;case 39:return!0;case 8:return!0;default:return}a.stopImmediatePropagation();a.preventDefault()},onKeyUp:function(a){var b;switch(a.keyCode){case 16:case 17:case 18:case 37:case 38:case 39:case 40:case 27:case 13:case 91:case 20:case 33:case 34:case 35:case 36:case 45:case 9:return!1}this.query=this.el_input.val().trim();this.queryLength=this.query.length;0===this.queryLength?(this.el_list_cont.empty(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),
this.el_XHRCounter.hide()):(b=this.query,this.beginLocalSearchFor(b),b.length>=this.options.minCharsForRemoteSearch?(this.showCountdownForXHR(),this.timers_func.endAndStart(h(function(){this.el_loader.show();this.beginRemoteSearchFor(b)},this),this.options.XHRTimeout,"RemoteSearchTimeout")):(this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),this.el_XHRCounter.hide()));return!1},showCountdownForXHR:function(){this.el_loader.hide();this.el_XHRCounter.stop(!0,!0).css("width","0").show();
this.el_XHRCounter.animate({width:"100%"},this.options.XHRTimeout,h(function(){this.el_XHRCounter.hide()},this))},beginLocalSearchFor:function(a){this.makeSuggestionListFor(a)},beginRemoteSearchFor:function(a){var b;b={};b[this.options.query_string]=a;e.getJSON(this.options.url,b,h(function(b){var c,f,g,e;f=!1;for(g=0,e=b.length;g<e;g++)c=b[g],this.data[c.id]||(f=!0,this.result_to_prepend.push({id:c.id,name:c.name}),this.data[c.id]=c.name);f&&a===this.query?(this.el_list_cont.find(".empty-message").remove(),
this.__dbSet(this.options.data_name+"_data",this.data),this.result_to_prepend=this.result_to_prepend.sort(function(a,b){return a.name<b.name?-1:1}),this.result_to_prepend=this.result_to_prepend.slice(0,this.options.maxNewResultsNum),this.insertNewResults(a)):this.el_list_cont.find(".empty-message").text("No results found");this.el_loader.hide()},this))},insertNewResults:function(){var a,b,d,c,f,g,k,m,i;b=j.createDocumentFragment();i=this.result_to_prepend;for(k=0,m=i.length;k<m;k++)d=i[k],c=j.createElement("li"),
a=j.createElement("a"),a.className="item",a.className+=" ajaxed",a.setAttribute("data-value",d.id),a.setAttribute("href","#"),a.setAttribute("style","display:none"),a.appendChild(j.createTextNode(d.name)),c.appendChild(a),b.appendChild(c);this.el_list_cont.prepend(b);this.el_list_cont[0].innerHTML+="";a=this.el_list_cont.find(".item.ajaxed");g=0;a.each(h(function(a,b){setTimeout(h(function(){e(b).slideDown(70)},this),g);g+=100},this));this.items_list=this.el_list_cont.find(".item");this.selected_item=
this.el_list_cont.find(".selected");f=this;this.items_list.on("mouseenter",{me:f},function(){return f.selectThisItem(e(this))});this.items_list.on("click",{me:f},function(){return f.activateTheSelectedItem()});this.highlightTextAndItems(a);this.result_to_prepend=[]},removeAccents:function(a){var b,d,c;c=this.options.list_of_replacable_chars;for(b in c)d=c[b],a=a.replace(d[0],d[1]);return a},makeSuggestionListFor:function(a){var b,d,c,f,g,e;g=[];d=this.removeAccents(a.toLowerCase());e=this.data;for(c in e)f=
e[c],b=this.removeAccents(f.toLowerCase()),-1!==b.indexOf(d)&&g.push({id:c,name:f});0===g.length&&(this.no_results=!0);this.result_list=g.slice(0,this.options.maxResultsNum);this.result_list=this.result_list.sort(function(a,b){return a.name<b.name?-1:1});this.printSuggestionList(a)},printSuggestionList:function(){var a,b,d,c,f,g,h,i;this.el_list_cont.empty();b=j.createDocumentFragment();if(0===this.result_list.length)c=j.createElement("li"),a=j.createElement("p"),a.className="empty-message",a.setAttribute("href",
"#"),this.query.length<this.options.minCharsForRemoteSearch?a.appendChild(j.createTextNode("No results found")):a.appendChild(j.createTextNode("loading...")),c.appendChild(a),b.appendChild(c),this.el_list_cont.append(b),this.el_list_cont[0].innerHTML+="";else{i=this.result_list;for(g=0,h=i.length;g<h;g++)d=i[g],c=j.createElement("li"),a=j.createElement("a"),a.className="item",a.setAttribute("data-value",d.id),a.setAttribute("href","#"),a.appendChild(j.createTextNode(d.name)),c.appendChild(a),b.appendChild(c);
this.el_list_cont.append(b);this.el_list_cont[0].innerHTML+="";this.items_list=this.el_list_cont.find(".item");f=this;this.items_list.on("mouseenter",{me:f},function(){return f.selectThisItem(e(this))});this.items_list.on("click",{me:f},function(){return f.activateTheSelectedItem()});this.selected_item=this.el_list_cont.find(".item:first").addClass("selected");this.highlightTextAndItems()}},highlightTextAndItems:function(a){""!==this.query&&(a=a||this.items_list,a.each(h(function(a,d){var c,f,g,h,
i;c=e(d).html();if(""!==this.query){f=this.query;i=this.options.list_of_replacable_chars;for(a in i)h=i[a],g=RegExp(h[1],"ig"),f=f.replace(g,"(?:"+h[0]+"|"+h[1]+")"),delete g;g=RegExp("("+f+")","ig");c=c.replace(g,"<span class='highlight'>$1</span>");delete g}e(d).html(c)},this)))},resetSelectItem:function(){this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>");this.hide()},activateTheSelectedItem:function(){this.el.html('<option value="'+this.selected_item.data("value")+
'" selected="selected">   '+this.selected_item.text()+"</option>");this.hide();return!1},selectThisItem:function(a){null!==this.selected_item&&(this.selected_item.removeClass("selected"),this.selected_item=null);this.selected_item=a.addClass("selected")},moveSelectedElement:function(a){var b,d,c;b=this.items_list.length;c=this.items_list.index(this.selected_item)+b;"up"===a?d=c-1:"down"===a&&(d=c+1);this.selectThisItem(this.items_list.filter(".item:nth("+d%b+")"))},setSelectItem:function(a,b){var d,
c,f;d=b||"refresh";if("object"===typeof a)f=a.value,c=a.text;else if("number"===typeof a)if(this.data&&this.data[a])f=a,c=this.data[a];else if(!0===i.makeWholeDumpXHR.call(this,{type:d}))if(this.data&&this.data[a])f=a,c=this.data[a];else return!1;else return!1;this.el.html('<option value="'+f+'" selected="selected">   '+c+"</option>");this.hide();return!0},refreshMyData:function(){return!1!==(this.data=this.__dbGet(this.options.data_name+"_data"))?!0:!1},showPreSelectedItem:function(){this.options.selected_id&&
this.setSelectItem(this.options.selected_id,"preselected")},__dbGet:function(a){return this.db.get(this.db_prefix+a)},__dbSet:function(a,b){return this.db.set(this.db_prefix+a,b)},__error:function(a,b){var d;b&&(d=a,a=b,b=d);d="@"+(this.options.app_name?this.options.app_name:"["+this.name+"]")+":";b&&(d=b+d);e.fn.toolsfreak.error_func(a,d)}};i.getLocalDBObj=function(){try{return e.fn.storagefreak()}catch(a){return this.__error("getLocalDBObj","could not get StorageFreak object"),null}};i.makeWholeDumpXHR=
function(a){var b,d,c,f;a&&a.type&&"initial"===a.type?(b="initiateLocalData",f="initial",d=!0):a&&a.type&&"refresh"===a.type?(b="refreshXHRForSetSelectItem",f="refresh",c=d=!1):a&&a.type&&"preselected"===a.type&&(b="XHRForPreselectedItem",f="preselected",d=!0);try{e.ajax({url:this.options.url,type:"get",dataType:"json",async:d,success:h(function(a){var d,e,g;e={};for(d in a)g=a[d],e[g.id]=g.name;if(!1===this.__dbSet(this.options.data_name+"_data",e))return this.__error(b,"error storing '"+this.options.data_name+
"' initial data to localStorage"),!1;if(!1===this.__dbSet(this.options.data_name+"_timestamp",(new Date).getTime()))return this.__error(b,"error storing timestamp"+this.options.app_name),!1;this.data=e;"initial"===f&&(this.showPreSelectedItem(),this.el_initial_loader.fadeOut(),this.el_top.removeClass("disabled"));return c=!0},this),error:h(function(){this.__error(b,"XHR error");return c=!1},this)})}catch(g){this.__error(b,"catched XHR error"),c=!1}return c};i.initiateLocalData=function(){var a;a=
(new Date).getTime();this.local_db_timestamp=this.__dbGet(this.options.data_name+"_timestamp");!1!==this.local_db_timestamp&&(this.local_db_timestamp=parseInt(this.local_db_timestamp,10));!1===this.local_db_timestamp||a-this.local_db_timestamp>this.options.localCacheTimeout?(this.el_initial_loader.show(),this.el_top.addClass("disabled"),i.makeWholeDumpXHR.call(this,{type:"initial"})):(this.data=this.__dbGet(this.options.data_name+"_data"),this.showPreSelectedItem())};e.fn.Selectorablium=function(a){this.each(function(){e.data(this,
"selectorablium")||e.data(this,"selectorablium",new i(this,a))})}})(jQuery,window,document)}).call(this);
