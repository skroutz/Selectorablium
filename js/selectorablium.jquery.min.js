((function(){(function(a,b,c){var d,e,f;f="selectorablium",e={minCharsForRemoteSearch:3,localCacheTimeout:6048e5,XHRTimeout:650,maxResultsNum:10,maxNewResultsNum:5,search_from_start:!0,list_of_replacable_chars:[["ά","α"],["έ","ε"],["ή","η"],["ί","ι"],["ό","ο"],["ύ","υ"],["ώ","ω"]]},d=function(b,c){if(!a.fn.toolsfreak)return!1;if(!a.fn.storagefreak)return!1;this.timers_func=a.fn.toolsfreak.timers_handler(),this.el=a(b).attr("autocomplete","off"),this.options=a.extend({},e,c);if(!this.options.app_name||this.options.app_name==="")return this.__error("objectCreation","no app_name specified on params"),!1;this.options.url=this.el.data("url"),this.options.query_string=this.el.data("query"),this.options.data_name=this.el.data("name"),this.options.default_value=this.el.data("default_value"),this.options.default_text=this.el.data("default_text"),this.options.selected_id=this.el.data("selected_id"),this.db=null,this.db_prefix="skr."+this.options.app_name+"."+f+".",this.el_container=null,this.el_top=null,this.el_inner_container=null,this.el_input=null,this.el_list_cont=null,this.el_XHRCounter=null,this.el_loader=null,this.el_clear=null,this.el_initial_loader=null,this.query="",this.queryLength="",this.data=null,this.result_list=null,this.selected_item=null,this.items_list=null,this.result_to_prepend=[],this.no_results=!1,this.do_not_hide_me=!1,this.got_focused=!1,this.init()},d.prototype={name:f,defaults:e,init:function(){this.createHtmlElements(),this.makeDbPreparation(),this.registerEventHandlers()},makeDbPreparation:function(){this.db=d.getLocalDBObj(),d.initiateLocalData.call(this)},createHtmlElements:function(){var b;this.el_container=a('<div class="selectorablium_cont">').css({width:this.el.outerWidth(),minHeight:this.el.outerHeight()}),b='<div class="top">',b+='<div class="initial_loader">Loading initial data...</div>',b+='<a class="cancel_button">Clear</a>',b+="</div>",b+='<div class="inner_container clearfix">',b+="<form>",b+='<input name="var_name">',b+='<span class="input_icon"></span>',b+='<div class="loader"></div>',b+='<div class="XHRCounter"></div>',b+="</form>",b+='<ul class="list_container"></ul>',b+="</div>",this.el_container.append(b),this.el_top=this.el_container.find(".top").css("height",this.el.outerHeight(!0)),this.el_inner_container=this.el_container.find(".inner_container"),this.el_input=this.el_container.find("input").attr("autocomplete","off"),this.el_list_cont=this.el_container.find(".list_container"),this.el_XHRCounter=this.el_container.find(".XHRCounter"),this.el_loader=this.el_container.find(".loader"),this.el_clear=this.el_container.find(".cancel_button").css({height:this.el.outerHeight(!0)+"px",lineHeight:this.el.outerHeight(!0)+"px"}),this.el_initial_loader=this.el_container.find(".initial_loader"),this.el.parent().css("position","relative").append(this.el_container),this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>"),this.el.css({borderBottomRightRadius:0,borderTopRightRadius:0})},registerEventHandlers:function(){var c=this;this.el_top.on("click",function(a){c.el_inner_container.is(":visible")?c.hide():c.el_top.hasClass("disabled")===!1&&(c.el_container.addClass("active"),c.el.addClass("active"),c.el_inner_container.slideDown(200),c.el_input.focus())}),this.el.on("focus",function(a){c.el_inner_container.is(":visible")?c.hide():c.el_top.hasClass("disabled")===!1&&(c.el_container.addClass("active"),c.el.addClass("active"),c.el_inner_container.slideDown(200),c.el_input.focus())}),this.el_container.on("click",function(a){c.do_not_hide_me=!0}),this.el_clear.on("click",function(a){return a.stopPropagation(),c.resetSelectItem(),!1}),a("html").on("click",function(a){c.do_not_hide_me===!0?c.do_not_hide_me=!1:c.hide()}),b.opera||a.browser.mozilla?this.el_input.on("keypress",function(a){return c.onKeyPress(a)}):this.el_input.on("keydown",function(a){return c.onKeyPress(a)}),this.el_input.on("keyup",function(a){return c.onKeyUp(a)})},hide:function(){this.el_inner_container.is(":visible")&&(this.el_container.removeClass("active"),this.el.removeClass("active"),this.el_inner_container.slideUp(200),this.el_input.val(""),this.el_list_cont.empty(),this.el_loader.hide(),this.el_XHRCounter.hide(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.query="")},onKeyPress:function(a){switch(a.keyCode){case 9:return this.selected_item?this.activateTheSelectedItem():this.hide(),!0;case 27:this.hide();break;case 38:return this.moveSelectedElement("up"),!1;case 40:return this.moveSelectedElement("down"),!1;case 13:return this.activateTheSelectedItem(),!1;case 37:return!0;case 39:return!0;case 8:return!0;default:return}a.stopImmediatePropagation(),a.preventDefault()},onKeyUp:function(a){var b,c=this;switch(a.keyCode){case 16:case 17:case 18:case 37:case 38:case 39:case 40:case 27:case 13:case 91:case 20:case 33:case 34:case 35:case 36:case 45:case 9:return!1}return this.query=this.el_input.val().trim(),this.queryLength=this.query.length,this.queryLength===0?(this.el_list_cont.empty(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),this.el_XHRCounter.hide()):(b=this.query,this.beginLocalSearchFor(b),b.length>=this.options.minCharsForRemoteSearch?(this.showCountdownForXHR(),this.timers_func.endAndStart(function(){c.el_loader.show(),c.beginRemoteSearchFor(b)},this.options.XHRTimeout,"RemoteSearchTimeout")):(this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),this.el_XHRCounter.hide())),!1},showCountdownForXHR:function(){var a=this;this.el_loader.hide(),this.el_XHRCounter.stop(!0,!0).css("width","0").show(),this.el_XHRCounter.animate({width:"100%"},this.options.XHRTimeout,function(){a.el_XHRCounter.hide()})},beginLocalSearchFor:function(a){this.makeSuggestionListFor(a)},beginRemoteSearchFor:function(b){var c,d=this;c={},c[this.options.query_string]=b,a.getJSON(this.options.url,c,function(a){var c,e,f,g;e=!1;for(f=0,g=a.length;f<g;f++)c=a[f],d.data[c.id]||(e=!0,d.result_to_prepend.push({id:c.id,name:c.name}),d.data[c.id]=c.name);e&&b===d.query?(d.el_list_cont.find(".empty-message").remove(),d.__dbSet(d.options.data_name+"_data",d.data),d.result_to_prepend=d.result_to_prepend.sort(function(a,b){return a.name<b.name?-1:1}),d.result_to_prepend=d.result_to_prepend.slice(0,d.options.maxNewResultsNum),d.insertNewResults(b)):d.el_list_cont.find(".empty-message").text("No results found"),d.el_loader.hide()})},insertNewResults:function(b){var d,e,f,g,h,i,j,k,l,m,n=this;e=c.createDocumentFragment(),m=this.result_to_prepend;for(k=0,l=m.length;k<l;k++)f=m[k],g=c.createElement("li"),d=c.createElement("a"),d.className="item",d.className+=" ajaxed",d.setAttribute("data-value",f.id),d.setAttribute("href","#"),d.setAttribute("style","display:none"),d.appendChild(c.createTextNode(f.name)),g.appendChild(d),e.appendChild(g);this.el_list_cont.prepend(e),this.el_list_cont[0].innerHTML+="",i=this.el_list_cont.find(".item.ajaxed"),j=0,i.each(function(b,c){setTimeout(function(){a(c).slideDown(70)},j),j+=100}),this.items_list=this.el_list_cont.find(".item"),this.selected_item=this.el_list_cont.find(".selected"),h=this,this.items_list.on("mouseenter",{me:h},function(){return h.selectThisItem(a(this))}),this.items_list.on("click",{me:h},function(){return h.activateTheSelectedItem()}),this.highlightTextAndItems(i),this.result_to_prepend=[]},removeAccents:function(a){var b,c,d,e;c=a,e=this.options.list_of_replacable_chars;for(b in e)d=e[b],c=c.replace(d[0],d[1]);return c},makeSuggestionListFor:function(a){var b,c,d,e,f,g;f=[],c=this.removeAccents(a.toLowerCase()),g=this.data;for(d in g)e=g[d],b=this.removeAccents(e.toLowerCase()),this.options.search_from_start===!0?b.indexOf(c)===0&&f.push({id:d,name:e}):b.indexOf(c)!==-1&&f.push({id:d,name:e});f.length===0&&(this.no_results=!0),this.result_list=f.slice(0,this.options.maxResultsNum),this.result_list=this.result_list.sort(function(a,b){return a.name<b.name?-1:1}),this.printSuggestionList(a)},printSuggestionList:function(){var b,d,e,f,g,h,i,j,k;this.el_list_cont.empty(),d=c.createDocumentFragment();if(this.result_list.length===0)f=c.createElement("li"),h=c.createElement("p"),h.className="empty-message",h.setAttribute("href","#"),this.query.length<this.options.minCharsForRemoteSearch?h.appendChild(c.createTextNode("No results found")):h.appendChild(c.createTextNode("loading...")),f.appendChild(h),d.appendChild(f),this.el_list_cont.append(d),this.el_list_cont[0].innerHTML+="";else{k=this.result_list;for(i=0,j=k.length;i<j;i++)e=k[i],f=c.createElement("li"),b=c.createElement("a"),b.className="item",b.setAttribute("data-value",e.id),b.setAttribute("href","#"),b.appendChild(c.createTextNode(e.name)),f.appendChild(b),d.appendChild(f);this.el_list_cont.append(d),this.el_list_cont[0].innerHTML+="",this.items_list=this.el_list_cont.find(".item"),g=this,this.items_list.on("mouseenter",{me:g},function(){return g.selectThisItem(a(this))}),this.items_list.on("click",{me:g},function(){return g.activateTheSelectedItem()}),this.selected_item=this.el_list_cont.find(".item:first").addClass("selected"),this.highlightTextAndItems()}},highlightTextAndItems:function(b){var c,d=this;this.query!==""&&(c=b||this.items_list,c.each(function(b,c){var e,f,g,h,i;e=a(c).html();if(d.query!==""){f=d.query,i=d.options.list_of_replacable_chars;for(b in i)h=i[b],g=new RegExp(h[1],"ig"),f=f.replace(g,"(?:"+h[0]+"|"+h[1]+")"),delete g;g=new RegExp("("+f+")","ig"),e=e.replace(g,"<span class='highlight'>$1</span>"),delete g}a(c).html(e)}))},resetSelectItem:function(){this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>"),this.hide()},activateTheSelectedItem:function(){return this.el.html('<option value="'+this.selected_item.data("value")+'" selected="selected">   '+this.selected_item.text()+"</option>"),this.el.trigger("change"),this.hide(),!1},selectThisItem:function(a){this.selected_item!==null&&(this.selected_item.removeClass("selected"),this.selected_item=null),this.selected_item=a.addClass("selected")},moveSelectedElement:function(a){var b,c,d;b=this.items_list.length,d=this.items_list.index(this.selected_item)+b,a==="up"?c=d-1:a==="down"&&(c=d+1),d=c%b,this.selectThisItem(this.items_list.filter(".item:nth("+d+")"))},setSelectItem:function(a,b){var c,e,f;c=b||"refresh";if(typeof a=="object")f=a.value,e=a.text;else if(typeof a=="number")if(this.data&&this.data[a])f=a,e=this.data[a];else{if(d.makeWholeDumpXHR.call(this,{type:c})!==!0)return!1;if(!this.data||!this.data[a])return!1;f=a,e=this.data[a]}return this.el.html('<option value="'+f+'" selected="selected">   '+e+"</option>"),this.hide(),!0},refreshMyData:function(){return(this.data=this.__dbGet(this.options.data_name+"_data"))!==!1?!0:!1},appendNewItem:function(a){return this.data[a.value]=a.name,this.__dbSet(this.options.data_name+"_data",this.data)===!1?(this.__error("appendNewItem","error storing '"+this.options.data_name+"' newly appended data"),!1):this.__dbSet(this.options.data_name+"_timestamp",(new Date).getTime())===!1?(this.__error("appendNewItem","error storing timestamp"+this.options.app_name),!1):!0},showPreSelectedItem:function(){this.options.selected_id&&this.setSelectItem(this.options.selected_id,"preselected")},__dbGet:function(a){return this.db.get(this.db_prefix+a)},__dbSet:function(a,b){return this.db.set(this.db_prefix+a,b)},__error:function(b,c){var d,e,f;c&&(f=b,b=c,c=f),d=this.options.app_name?this.options.app_name:"["+this.name+"]",e="@"+d+":",c&&(e=c+e),a.fn.toolsfreak.error_func(b,e)}},d.getLocalDBObj=function(){try{return a.fn.storagefreak()}catch(b){return this.__error("getLocalDBObj","could not get StorageFreak object"),null}},d.makeWholeDumpXHR=function(b){var c,d,e,f,g=this;b&&b.type&&b.type==="initial"?(c="initiateLocalData",f="initial",d=!0):b&&b.type&&b.type==="refresh"?(c="refreshXHRForSetSelectItem",f="refresh",d=!1,e=!1):b&&b.type&&b.type==="preselected"&&(c="XHRForPreselectedItem",f="preselected",d=!0);try{a.ajax({url:this.options.url,type:"get",dataType:"json",async:d,success:function(a){var b,d,h,i,j;h={},i={},d=0;for(b in a)j=a[b],h[j.id]=j.name,d+=1;return g.__dbSet(g.options.data_name+"_data",h)===!1?(g.__error(c,"error storing '"+g.options.data_name+"' initial data to localStorage"),!1):g.__dbSet(g.options.data_name+"_timestamp",(new Date).getTime())===!1?(g.__error(c,"error storing timestamp"+g.options.app_name),!1):(g.data=h,f==="initial"&&(g.showPreSelectedItem(),g.el_initial_loader.fadeOut(),g.el_top.removeClass("disabled")),e=!0,!0)},error:function(a,b,d){return g.__error(c,"XHR error"),e=!1,!1}})}catch(h){this.__error(c,"catched XHR error"),e=!1}return e},d.initiateLocalData=function(){var a;a=(new Date).getTime(),this.local_db_timestamp=this.__dbGet(this.options.data_name+"_timestamp"),this.local_db_timestamp!==!1&&(this.local_db_timestamp=parseInt(this.local_db_timestamp,10)),this.local_db_timestamp===!1||a-this.local_db_timestamp>this.options.localCacheTimeout?(this.el_initial_loader.show(),this.el_top.addClass("disabled"),d.makeWholeDumpXHR.call(this,{type:"initial"})):(this.data=this.__dbGet(this.options.data_name+"_data"),this.showPreSelectedItem())},a.fn.Selectorablium=function(b){this.each(function(){a.data(this,f)||a.data(this,f,new d(this,b))})}})(jQuery,window,document)})).call(this);