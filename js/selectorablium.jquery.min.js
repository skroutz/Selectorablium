// Generated by CoffeeScript 1.3.3
(function(){var e={}.hasOwnProperty;(function(t,n,r){var i,s,o;o="selectorablium",s={minCharsForRemoteSearch:3,localCacheTimeout:6048e5,XHRTimeout:650,maxResultsNum:10,maxNewResultsNum:5,search_from_start:!0,list_of_replacable_chars:[["ά","α"],["έ","ε"],["ή","η"],["ί","ι"],["ό","ο"],["ύ","υ"],["ώ","ω"]]},i=function(e,n){if(!t.fn.toolsfreak)return!1;if(!t.fn.storagefreak)return!1;this.timers_func=t.fn.toolsfreak.timers_handler(),this.el=t(e).attr("autocomplete","off"),this.options=t.extend({},s,n);if(!this.options.app_name||this.options.app_name==="")return this.__error("objectCreation","no app_name specified on params"),!1;this.options.url=this.el.data("url"),this.options.query_string=this.el.data("query"),this.options.data_name=this.el.data("name"),this.options.default_value=this.el.data("default_value"),this.options.default_text=this.el.data("default_text"),this.options.selected_id=this.el.data("selected_id"),this.db=null,this.db_prefix="skr."+this.options.app_name+"."+o+".",this.el_container=null,this.el_top=null,this.el_inner_container=null,this.el_input=null,this.el_list_cont=null,this.el_XHRCounter=null,this.el_loader=null,this.el_clear=null,this.el_initial_loader=null,this.query="",this.queryLength="",this.data=null,this.result_list=null,this.selected_item=null,this.items_list=null,this.result_to_prepend=[],this.no_results=!1,this.do_not_hide_me=!1,this.got_focused=!1,this.init()},i.prototype={name:o,defaults:s,init:function(){this.createHtmlElements(),this.makeDbPreparation(),this.registerEventHandlers()},makeDbPreparation:function(){this.db=i.getLocalDBObj(),i.initiateLocalData.call(this)},createHtmlElements:function(){var e;this.el_container=t('<div class="selectorablium_cont">').css({width:this.el.outerWidth(),minHeight:this.el.outerHeight()}),e='<div class="top">',e+='<div class="initial_loader">Loading initial data...</div>',e+='<a class="cancel_button">Clear</a>',e+="</div>",e+='<div class="inner_container clearfix">',e+="<form>",e+='<input name="var_name">',e+='<span class="input_icon"></span>',e+='<div class="loader"></div>',e+='<div class="XHRCounter"></div>',e+="</form>",e+='<ul class="list_container"></ul>',e+="</div>",this.el_container.append(e),this.el_top=this.el_container.find(".top").css("height",this.el.outerHeight(!0)),this.el_inner_container=this.el_container.find(".inner_container"),this.el_input=this.el_container.find("input").attr("autocomplete","off"),this.el_list_cont=this.el_container.find(".list_container"),this.el_XHRCounter=this.el_container.find(".XHRCounter"),this.el_loader=this.el_container.find(".loader"),this.el_clear=this.el_container.find(".cancel_button").css({height:this.el.outerHeight(!0)+"px",lineHeight:this.el.outerHeight(!0)+"px"}),this.el_initial_loader=this.el_container.find(".initial_loader"),this.el.parent().css("position","relative").append(this.el_container),this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>"),this.el.css({borderBottomRightRadius:0,borderTopRightRadius:0})},registerEventHandlers:function(){var e=this;this.el_top.on("click",function(t){e.el_inner_container.is(":visible")?e.hide():e.el_top.hasClass("disabled")===!1&&(e.el_container.addClass("active"),e.el.addClass("active"),e.el_inner_container.slideDown(200),e.el_input.focus())}),this.el.on("focus",function(t){e.el_inner_container.is(":visible")?e.hide():e.el_top.hasClass("disabled")===!1&&(e.el_container.addClass("active"),e.el.addClass("active"),e.el_inner_container.slideDown(200),e.el_input.focus())}),this.el_container.on("click",function(t){e.do_not_hide_me=!0}),this.el_clear.on("click",function(t){return t.stopPropagation(),e.resetSelectItem(),!1}),t("html").on("click",function(t){e.do_not_hide_me===!0?e.do_not_hide_me=!1:e.hide()}),n.opera||t.browser.mozilla?this.el_input.on("keypress",function(t){return e.onKeyPress(t)}):this.el_input.on("keydown",function(t){return e.onKeyPress(t)}),this.el_input.on("keyup",function(t){return e.onKeyUp(t)}),this.el_list_cont.delegate(".item","mouseenter",function(e){return me.selectThisItem(t(this))}),this.el_list_cont.delegate(".item","click",function(e){return me.activateTheSelectedItem()})},hide:function(){this.el_inner_container.is(":visible")&&(this.el_container.removeClass("active"),this.el.removeClass("active"),this.el_inner_container.slideUp(200),this.el_input.val(""),this.el_list_cont.empty(),this.el_loader.hide(),this.el_XHRCounter.hide(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.query="")},onKeyPress:function(e){switch(e.keyCode){case 9:return this.selected_item?this.activateTheSelectedItem():this.hide(),!0;case 27:this.hide();break;case 38:return this.moveSelectedElement("up"),!1;case 40:return this.moveSelectedElement("down"),!1;case 13:return this.activateTheSelectedItem(),!1;case 37:return!0;case 39:return!0;case 8:return!0;default:return}e.stopImmediatePropagation(),e.preventDefault()},onKeyUp:function(e){var t,n=this;switch(e.keyCode){case 16:case 17:case 18:case 37:case 38:case 39:case 40:case 27:case 13:case 91:case 20:case 33:case 34:case 35:case 36:case 45:case 9:return!1}return this.query=this.el_input.val().trim(),this.queryLength=this.query.length,this.queryLength===0?(this.el_list_cont.empty(),this.selected_item=null,this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),this.el_XHRCounter.hide()):(t=this.query,this.beginLocalSearchFor(t),t.length>=this.options.minCharsForRemoteSearch?(this.showCountdownForXHR(),this.timers_func.endAndStart(function(){n.el_loader.show(),n.beginRemoteSearchFor(t)},this.options.XHRTimeout,"RemoteSearchTimeout")):(this.timers_func.end("RemoteSearchTimeout"),this.el_loader.hide(),this.el_XHRCounter.hide())),!1},showCountdownForXHR:function(){var e=this;this.el_loader.hide(),this.el_XHRCounter.stop(!0,!0).css("width","0").show(),this.el_XHRCounter.animate({width:"100%"},this.options.XHRTimeout,function(){e.el_XHRCounter.hide()})},beginLocalSearchFor:function(e){this.makeSuggestionListFor(e)},beginRemoteSearchFor:function(e){var n,r=this;n={},n[this.options.query_string]=e,t.getJSON(this.options.url,n,function(t){var n,i,s,o;i=!1;for(s=0,o=t.length;s<o;s++)n=t[s],r.data[n.id]||(i=!0,r.result_to_prepend.push({id:n.id,name:n.name}),r.data[n.id]=n.name);i&&e===r.query?(r.el_list_cont.find(".empty-message").remove(),r.__dbSet(r.options.data_name+"_data",r.data),r.result_to_prepend=r.result_to_prepend.sort(function(e,t){return e.name<t.name?-1:1}),r.result_to_prepend=r.result_to_prepend.slice(0,r.options.maxNewResultsNum),r.insertNewResults(e)):r.el_list_cont.find(".empty-message").text("No results found"),r.el_loader.hide()})},insertNewResults:function(e){var n,i,s,o,u,a,f,l,c,h=this;i=r.createDocumentFragment(),c=this.result_to_prepend;for(f=0,l=c.length;f<l;f++)s=c[f],o=r.createElement("li"),n=r.createElement("a"),n.className="item",n.className+=" ajaxed",n.setAttribute("data-value",s.id),n.setAttribute("href","#"),n.setAttribute("style","display:none"),n.appendChild(r.createTextNode(s.name)),o.appendChild(n),i.appendChild(o);this.el_list_cont.prepend(i),this.el_list_cont[0].innerHTML+="",u=this.el_list_cont.find(".item.ajaxed"),a=0,u.each(function(e,n){setTimeout(function(){t(n).slideDown(70)},a),a+=100}),this.items_list=this.el_list_cont.find(".item"),this.selected_item=this.el_list_cont.find(".selected"),this.highlightTextAndItems(u),this.result_to_prepend=[]},removeAccents:function(e){var t,n,r,i,s;t=e,s=this.options.list_of_replacable_chars;for(r=0,i=s.length;r<i;r++)n=s[r],t=t.replace(n[0],n[1]);return t},makeSuggestionListFor:function(t){var n,r,i,s,o,u;o=[],r=this.removeAccents(t.toLowerCase()),u=this.data;for(i in u){if(!e.call(u,i))continue;s=u[i],n=this.removeAccents(s.toLowerCase()),this.options.search_from_start===!0?n.indexOf(r)===0&&o.push({id:i,name:s}):n.indexOf(r)!==-1&&o.push({id:i,name:s})}o.length===0&&(this.no_results=!0),o=o.sort(function(e,t){return e.name<t.name?-1:1}),this.result_list=o.slice(0,this.options.maxResultsNum),this.printSuggestionList(t)},printSuggestionList:function(){var e,t,n,i,s,o,u,a;this.el_list_cont.empty(),t=r.createDocumentFragment();if(this.result_list.length===0)i=r.createElement("li"),s=r.createElement("p"),s.className="empty-message",s.setAttribute("href","#"),this.query.length<this.options.minCharsForRemoteSearch?s.appendChild(r.createTextNode("No results found")):s.appendChild(r.createTextNode("loading...")),i.appendChild(s),t.appendChild(i),this.el_list_cont.append(t),this.el_list_cont[0].innerHTML+="";else{a=this.result_list;for(o=0,u=a.length;o<u;o++)n=a[o],i=r.createElement("li"),e=r.createElement("a"),e.className="item",e.setAttribute("data-value",n.id),e.setAttribute("href","#"),e.appendChild(r.createTextNode(n.name)),i.appendChild(e),t.appendChild(i);this.el_list_cont.append(t),this.el_list_cont[0].innerHTML+="",this.items_list=this.el_list_cont.find(".item"),this.selected_item=this.el_list_cont.find(".item:first").addClass("selected"),this.highlightTextAndItems()}},highlightTextAndItems:function(e){var n,r=this;this.query!==""&&(n=e||this.items_list,n.each(function(e,n){var i,s,o,u,a,f,l;i=t(n).html();if(r.query!==""){s=r.query,l=r.options.list_of_replacable_chars;for(a=0,f=l.length;a<f;a++)u=l[a],o=new RegExp(u[1],"ig"),s=s.replace(o,"(?:"+u[0]+"|"+u[1]+")"),o=null;o=new RegExp("("+s+")","ig"),i=i.replace(o,"<span class='highlight'>$1</span>"),o=null}t(n).html(i)}))},resetSelectItem:function(){this.el.html('<option value="'+this.options.default_value+'">'+this.options.default_text+"</option>"),this.hide()},activateTheSelectedItem:function(){return this.el.html('<option value="'+this.selected_item.data("value")+'" selected="selected">   '+this.selected_item.text()+"</option>"),this.el.trigger("change"),this.hide(),!1},selectThisItem:function(e){this.selected_item!==null&&(this.selected_item.removeClass("selected"),this.selected_item=null),this.selected_item=e.addClass("selected")},moveSelectedElement:function(e){var t,n,r;t=this.items_list.length,r=this.items_list.index(this.selected_item)+t,e==="up"?n=r-1:e==="down"&&(n=r+1),r=n%t,this.selectThisItem(this.items_list.filter(".item:nth("+r+")"))},setSelectItem:function(e,t){var n,r,s;n=t||"refresh";if(typeof e=="object")s=e.value,r=e.text;else if(typeof e=="number")if(this.data&&this.data[e])s=e,r=this.data[e];else{if(i.makeWholeDumpXHR.call(this,{type:n})!==!0)return!1;if(!this.data||!this.data[e])return!1;s=e,r=this.data[e]}return this.el.html('<option value="'+s+'" selected="selected">   '+r+"</option>"),this.hide(),!0},refreshMyData:function(){return(this.data=this.__dbGet(this.options.data_name+"_data"))!==!1?!0:!1},appendNewItem:function(e){return this.data[e.value]=e.name,this.__dbSet(this.options.data_name+"_data",this.data)===!1?(this.__error("appendNewItem","error storing '"+this.options.data_name+"' newly appended data"),!1):this.__dbSet(this.options.data_name+"_timestamp",(new Date).getTime())===!1?(this.__error("appendNewItem","error storing timestamp"+this.options.app_name),!1):!0},showPreSelectedItem:function(){this.options.selected_id&&this.setSelectItem(this.options.selected_id,"preselected")},__dbGet:function(e){return this.db.get(this.db_prefix+e)},__dbSet:function(e,t){return this.db.set(this.db_prefix+e,t)},__error:function(e,n){var r,i,s;n&&(s=e,e=n,n=s),r=this.options.app_name?this.options.app_name:"["+this.name+"]",i="@"+r+":",n&&(i=n+i),t.fn.toolsfreak.error_func(e,i)}},i.getLocalDBObj=function(){try{return t.fn.storagefreak()}catch(e){return this.__error("getLocalDBObj","could not get StorageFreak object"),null}},i.makeWholeDumpXHR=function(n){var r,i,s,o,u=this;n&&n.type&&n.type==="initial"?(r="initiateLocalData",o="initial",i=!0):n&&n.type&&n.type==="refresh"?(r="refreshXHRForSetSelectItem",o="refresh",i=!1,s=!1):n&&n.type&&n.type==="preselected"&&(r="XHRForPreselectedItem",o="preselected",i=!0);try{t.ajax({url:this.options.url,type:"get",dataType:"json",async:i,success:function(t){var n,i,a,f,l;a={},f={},i=0;for(n in t){if(!e.call(t,n))continue;l=t[n],a[l.id]=l.name,i+=1}return u.__dbSet(u.options.data_name+"_data",a)===!1?(u.__error(r,"error storing '"+u.options.data_name+"' initial data to localStorage"),!1):u.__dbSet(u.options.data_name+"_timestamp",(new Date).getTime())===!1?(u.__error(r,"error storing timestamp"+u.options.app_name),!1):(u.data=a,o==="initial"&&(u.showPreSelectedItem(),u.el_initial_loader.fadeOut(),u.el_top.removeClass("disabled")),s=!0,!0)},error:function(e,t,n){return u.__error(r,"XHR error"),s=!1,!1}})}catch(a){this.__error(r,"catched XHR error"),s=!1}return s},i.initiateLocalData=function(){var e;e=(new Date).getTime(),this.local_db_timestamp=this.__dbGet(this.options.data_name+"_timestamp"),this.local_db_timestamp!==!1&&(this.local_db_timestamp=parseInt(this.local_db_timestamp,10)),this.local_db_timestamp===!1||e-this.local_db_timestamp>this.options.localCacheTimeout?(this.el_initial_loader.show(),this.el_top.addClass("disabled"),i.makeWholeDumpXHR.call(this,{type:"initial"})):(this.data=this.__dbGet(this.options.data_name+"_data"),this.showPreSelectedItem())},t.fn.Selectorablium=function(e){this.each(function(){t.data(this,o)||t.data(this,o,new i(this,e))})}})(jQuery,window,document)}).call(this);